<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Cuenta - TinakAward</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="./stylesheet2.css" rel="stylesheet">
</head>
<body>
   
    <header>
        <img src="./imgs/logo-nobg.png" class="header-logo" alt="Logo TiankAwards">
    </header>

    <div class="create-account-container">
        <h2>Crear Nueva Cuenta</h2>

        <div id="accountTypeSelection" class="form-section show">
            <h3>¿Qué tipo de cuenta deseas crear?</h3>
            <div class="button-group">
                <button type="button" class="btn-select-type" data-account-type="cliente">Soy Cliente</button>
                <button type="button" class="btn-select-type" data-account-type="empresa">Soy Empresa</button>
            </div>
        </div>

        <form id="registrationForm" class="form-section" style="display: none;">
            <h3>Registro de Cuenta <span id="selectedAccountType"></span></h3>
            
            <div class="form-group">
                <label for="regEmail">Correo Electrónico</label>
                <input type="email" id="regEmail" name="email" placeholder="tu@ejemplo.com" required>
            </div>

            <div class="form-group">
                <label for="username">Nombre de Usuario</label>
                <input type="text" id="username" name="username" placeholder="TuNombreDeUsuario" required>
            </div>

            <button type="submit" class="btn-connect">Conectar Wallet y Registrar</button>
            <button type="button" class="btn-back" onclick="window.location.href='index.html'">Volver al Inicio</button>
        </form>
    </div>

    <script src="https://unpkg.com/@stellar/freighter-api@latest/dist/freighter.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const headerLogo = document.querySelector('.header-logo');
            const createAccountContainer = document.querySelector('.create-account-container');
            const accountTypeSelection = document.getElementById('accountTypeSelection');
            const registrationForm = document.getElementById('registrationForm');
            const selectedAccountTypeSpan = document.getElementById('selectedAccountType');
            const btnSelectType = document.querySelectorAll('.btn-select-type');

            setTimeout(() => {
                headerLogo.classList.add('show');
                createAccountContainer.classList.add('show');
            }, 100);

            btnSelectType.forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('data-account-type');
                    selectedAccountTypeSpan.textContent = `(${type === 'cliente' ? 'Cliente' : 'Empresa'})`;
                    
                    accountTypeSelection.classList.remove('show');
                    accountTypeSelection.style.display = 'none';

                    setTimeout(() => {
                        registrationForm.style.display = 'block';
                        registrationForm.classList.add('show');
                        registrationForm.dataset.accountType = type;
                    }, 300);
                });
            });

            document.getElementById('registrationForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const email = document.getElementById('regEmail').value.trim();
                const username = document.getElementById('username').value.trim();
                const accountType = this.dataset.accountType;

                if (!email || !username) {
                    alert('Por favor, completa todos los campos.');
                    return;
                }

                try {
                    const walletInfo = await connectWallet(); // Conectar wallet
                    const stellarPublicKey = walletInfo.address;

                    // Enviar datos al backend para registro
                    const response = await fetch('http://localhost:3000/api/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, username, accountType, stellarPublicKey })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.message);
                         // Simular sesión de usuario en localStorage para pruebas locales
                        localStorage.setItem('currentUser', JSON.stringify(data.user));

                        if (accountType === 'empresa') {
                             window.location.href = 'Account_Empresa.html'; 
                        } else {
                             window.location.href = 'account_cliente.html'; 
                        }
                    } else {
                        alert(`Error en el registro: ${data.message}`);
                    }

                } catch (error) {
                    console.error("Error durante el registro y conexión a la wallet:", error);
                    alert(`Error: ${error.message}. Por favor, inténtalo de nuevo con tu proveedor Web3 de Stellar (Freighter).`);
                }
            });
        });

        async function connectWallet() { // Ya no recibe email como argumento
            console.log("Intentando conectar con la wallet Web3 de Stellar (Freighter) para registro...");
            if (window.freighterApi) {
                try {
                    const publicKey = await window.freighterApi.getPublicKey();
                    console.log("Wallet Stellar conectada (Public Key):", publicKey);
                    return { success: true, address: publicKey };
                } catch (error) {
                    if (error.message.includes("User declined the connection")) {
                        throw new Error("Conexión a la wallet Stellar rechazada por el usuario.");
                    } else {
                        throw new Error(`Error al conectar con la wallet Stellar: ${error.message}`);
                    }
                }
            } else {
                throw new Error("No se detectó el proveedor de Stellar (Freighter). Por favor, instala la extensión.");
            }
        }
    </script>
</body>

</html>

  